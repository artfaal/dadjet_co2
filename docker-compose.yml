services:

  # ──────────────────────────────────────────────────────────────────────────
  # co2mond — демон считывания данных с USB-датчика CO2 (Holtek 04d9:a052)
  # Экспортирует Prometheus-метрики на :9999/metrics
  # ──────────────────────────────────────────────────────────────────────────
  co2mond:
    build:
      context: .
      target: co2mond
    image: dadjet-co2mond:latest
    container_name: co2mond
    restart: unless-stopped
    # privileged нужен для доступа к USB HID устройству из контейнера.
    # Менее привилегированная альтернатива: убрать privileged и раскомментировать
    # devices + настроить udev rules на хосте (см. README).
    privileged: true
    # devices:
    #   - /dev/bus/usb:/dev/bus/usb
    networks:
      - co2net
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"

  # ──────────────────────────────────────────────────────────────────────────
  # co2push — публикация данных в Prometheus Pushgateway или MQTT
  # По умолчанию: Pushgateway. Для MQTT — поменять command ниже.
  # ──────────────────────────────────────────────────────────────────────────
  co2push:
    build:
      context: .
      target: co2push
    image: dadjet-co2push:latest
    container_name: co2push
    restart: unless-stopped
    depends_on:
      - co2mond
    env_file: .env
    environment:
      # Перекрываем LOCAL_METRICS_URL: внутри Docker-сети используем имя сервиса
      LOCAL_METRICS_URL: http://co2mond:9999/metrics
    volumes:
      # Скрипты ищут .env файл через source — монтируем его в контейнер
      - ./.env:/app/.env:ro
    networks:
      - co2net
    security_opt:
      - no-new-privileges:true
    command: ["/app/push_co2_data.sh"]
    # Для MQTT — заменить command выше на:
    # command: ["/app/push_co2_mqtt.sh"]
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"

networks:
  co2net:
    driver: bridge
